# ACF-VS (Anime Cut Folder Versioning System)

アニメーション制作の撮影工程（Compositing）に特化した、分散作業用の軽量なハッシュベース・バージョン管理システムです。コマンドライン（CLI）ツールに加えて、Windows環境ですぐに使える直感的な PowerShell GUI (`acvs_gui.ps1`) を備えています。

---

## 📖 目次
1. [ACF-VS とは？（解決する課題）](#1-acf-vs-とは解決する課題)
2. [主な機能と特徴](#2-主な機能と特徴)
3. [インストールと準備](#3-インストールと準備)
4. [GUIツールの使い方 (Windows推奨)](#4-guiツールの使い方-windows推奨)
5. [コマンドライン連携の使い方 (中〜上級者向け)](#5-コマンドライン連携の使い方-中上級者向け)
6. [動作の仕組み（管理ファイルについて）](#6-動作の仕組み管理ファイルについて)
7. [テスト環境の構築](#7-テスト環境の構築)

---

## 1. ACF-VS とは？（解決する課題）

アニメ制作では1つの「カットフォルダ」の中に、Photoshop(BG), Paint(CELL), 3D素材, AfterEffectsプロジェクトなど多数のファイルが含まれます。
作業者間でデータをやり取りする際、古いファイルを `(old)` というサブフォルダに移動して整理する運用がよく行われますが、「誰が・いつ・どのファイルを新しいものに差し替えたか」が分からなくなる事故が頻発します。

Gitなどの標準的なソースコード用バージョン管理システムでは、数GBに及ぶ巨大なバイナリファイルや数千枚の連番画像の履歴を保持すると動作が破綻してしまいます。

**ACF-VS** は、ファイルの実体（データそのもの）を丸ごと保存するのではなく、**「ファイルのハッシュ値（指紋）と場所の状態」のみを記録する軽量なシステム** です。実体のコピーを持たずに差分と構成だけを監視するため、巨大なアニメーション素材フォルダでも数秒〜数分でバージョンを比較・管理できるのが最大の特徴です。

---

## 2. 主な機能と特徴

*   **ハッシュベースの同一性判定**: SHA-256ハッシュを用いて判定するため、ファイル名が変更されても「同じファイル」として追跡します。
*   **`(old)` フォルダのアーカイブ認識**: `Active` な場所にあったファイルが `(old)` という名を含むパスへ移動された場合、単なる「削除と新規作成」ではなく「アーカイブ化」として認識します。
*   **高速モード (Fast Mode)**: 巨大なPSDやAEPファイルを扱うため、完全なデータ読み込み計算の代わりに「ファイルサイズ＋更新日時」だけを用いた高速判定 (`--fast`) に標準で対応しています。
*   **連番画像の自動グループ化**: 数千枚におよぶ連番画像（例: `A_cell_0001.tga` 〜 `1000.tga`）をパターン認識し、1つの統合されたシーケンス（`[0001-1000].tga`）として扱います。これにより画面の出力が劇的に見やすくなり、処理速度も向上します (`--seq`)。
*   **重複ファイル検知**: 全く同じハッシュ値を持つファイルがカットフォルダ内の別の階層に存在する場合、「Redundant Copies」として警告を出します。
*   **スマートな履歴管理と差分追跡 (Smart Archive)**:
    * コミット（記録）するごとに過去の状態をバックアップします。
    * 「変更がなかった時の記録」は一時保存に留め、次にファイルが更新されたタイミングで過去の無駄な「無変更記録」を自動破棄します（ログが綺麗に保たれます）。
    * 過去の任意の日時を指定して、「3日前から何が変わったか？」を正確に比較表示（diff）できます。

---

## 3. インストールと準備

本システムは Python スクリプトを中心に構成されており、追加のライブラリ（`pip install` 等）は不要です。

### 必要な環境
*   **Windows 10 / 11** (GUIツールを使用する場合)
*   **Python 3.10 以上** がインストールされ、パス(Path)が通っていること。

### インストール手順
1. このリポジトリをZIPでダウンロードするか、Gitでクローンします。
    ```bash
    git clone https://github.com/o3x/ACF-VS.git
    cd ACF-VS
    ```
2. 任意の作業し易い場所にフォルダごと配置してください。

---

## 4. GUIツールの使い方 (Windows推奨)

コマンドプロンプトやターミナルを開くことなく、直感的に操作できるGUIパネルが用意されています。

### 起動方法
1. エクスプローラー上で `acvs_gui.ps1` を右クリックします。
2. **「PowerShell で実行」** をクリックします。（またはターミナルから `.\acvs_gui.ps1` を実行）

### 画面の各機能
*   **エピソードルート (Root Dir)**:
    *   全カットフォルダが格納されている大元（話数など）のディレクトリを「参照...」ボタンから指定します。（例: `\\Server\Project\Ep01`）
*   **カット番号**:
    *   チェックしたい対象のカットフォルダ名を入力します。（例: `c001`）
*   **Scan (Status) ボタン** *(Enterキーで代用可)*:
    *   前回の記録（マニフェスト）と比較し、**「現在何が変更されているか」** を下部の黒いコンソールに表示します。（データはまだ上書き記録されません）
*   **Commit (Save) ボタン**:
    *   現在のカットフォルダの状態をスキャンし、新しい「正」として更新（保存）します。
    *   同時に、過去の状態がタイムスタンプ付きでバックアップされます（Smart Archive機能）。
*   **History Log ボタン**:
    *   そのカットの「いつコミットされたか」の履歴一覧を表示します。無変更で完了したかどうかのステータスも確認できます。
*   チェックボックス (`Fast Mode`, `Group Seq Images`):
    *   基本的に両方「ON」のままで、巨大ファイルおよび大量連番画像に対する最適化処理が有効になります。

---

## 5. コマンドライン連携の使い方 (中〜上級者向け)

バッチ処理や自動化、詳細な差分確認を行いたい場合は、各カットフォルダのルート（一番上の階層）で直接 `acvs_core.py` を実行します。

### 1. マニフェストの初期化 (`init`)
現在のフォルダの状態をスキャンし、最初のベースとなる記録ファイル（`.cut_manifest.json`）を生成します。
```bash
python acvs_core.py init --dir <対象のカットフォルダ>
```

### 2. 現在の差分を確認 (`status` / `scan`)
前回の記録と比較し、新規追加・更新・削除・アーカイブ移動などの差分を表示します。
```bash
# アニメ特化のオプション：巨大ファイル向け高速化 ＆ 連番画像のグループ化
python acvs_core.py status --dir <対象のカットフォルダ> --fast --seq
```

### 3. バージョンの更新と履歴保存 (`commit`)
現状を新しい記録として上書き保存し、同時に `.acvs_history` フォルダに過去スナップショットを記録します。
```bash
python acvs_core.py commit --dir <対象のカットフォルダ> --fast --seq
```

### 4. 履歴の確認 (`log` / `diff`)
過去のコミット履歴を確認し、特定の時点からの差分（変更されたファイル）を調査できます。
```bash
# 過去のコミット履歴（日時）とステータスを一覧表示
python acvs_core.py log --dir <対象のカットフォルダ>

# 出力例を元に、特定のタイムスタンプの記録と現在のフォルダ状況を比較する
python acvs_core.py diff --target 20260227_182939 --dir <対象のカットフォルダ> --fast --seq
```

---

## 6. 動作の仕組み（管理ファイルについて）

ACF-VS を使用すると、対象のカットフォルダの中に以下の「隠しファイル・フォルダ」が生成されます。
*これらはファイル構成を保存するためのデータベースであり、Gitにおける `.git/` フォルダと同じ役目を果たします。*

*   **`.cut_manifest.json`**:
    *   現在のカットフォルダ内の「全ファイルのリストとハッシュ値」を記憶している最新のメインファイルです。
*   **`.acvs_history/` (ディレクトリ)**:
    *   `commit` が行われるたびに、過去の `.cut_manifest.json` が `日時.json` としてここに保管されていきます。

---

## 7. テスト環境の構築

実際にACF-VSの挙動を安全に手元でご検証いただくため、ダミーの連番画像環境を一括生成するスクリプトが付属しています。

```bash
python test_seq_generator.py --dir test_env --count 1000
```
これにより、`test_env/CELL/A_cell/` フォルダ等に1000枚のダミー連番ファイルが一瞬で生成され、スキャンやコミットの速度、`(old)` フォルダ移動時の挙動などを安全にテストしていただけます。

---
**License:** MIT License
