# ACF-VS (Anime Cut Folder Versioning System)

アニメーション制作の撮影工程（Compositing）に特化した、分散作業用の軽量なハッシュベース・バージョン管理システムです。

## 概要 (Overview)

アニメ制作では1つの「カットフォルダ」の中に、Photoshop(BG), Paint(CELL), 3D, AfterEffectsなど多数の素材が含まれます。
作業者によって古いファイルを `(old)` などのサブフォルダに移動する運用がなされることが多く、Gitなどの標準的なバージョン管理では巨大なバイナリファイルの履歴管理が重すぎたり、リネームや移動の追跡が困難になったりする問題がありました。

**ACF-VS** は、ファイルの実体ではなく「ファイルのハッシュ値（指紋）と場所の状態」のみを `.cut_manifest.json` という軽量なマニフェストファイルで管理するCLIツールです。

## 主な特徴 (Features)

*   **ハッシュベースの同一性判定**: SHA-256ハッシュを用いて、ファイル名が変更されても同じファイルとして追跡可能。
*   **`(old)` フォルダのアーカイブ認識**: `Active` な場所にあったファイルが `(old)` という名を含むパスへ移動された場合、単なる「削除と新規作成」ではなく「アーカイブ化」として認識します。
*   **高速モード (Fast Mode)**: 巨大なPSDやAEPファイルを扱うため、完全なハッシュ計算の代わりに「ファイルサイズ＋更新日時」を用いた高速判定 (`--fast`) に対応。
*   **連番画像の自動グループ化**: 数千枚におよぶ連番画像（例: `A_cell_0001.tga` 〜 `1000.tga`）をパターン認識し、1つの統合されたシーケンスとして扱いスキャン結果を要約・高速化します (`--seq`)。
*   **重複ファイル検知**: 全く同じハッシュ値を持つファイルがカットフォルダ内の別の階層に存在する場合、「Redundant Copies」として警告を出します。
*   **履歴管理と差分追跡 (Smart Archive)**: `commit` ごとに前回の状態を保存します。変更がなかった場合は一時記録とし、変更があった際に古い無変更履歴を破棄することで、意味のあるスナップショットだけを整理して残します。
*   **PowerShell GUI**: CLIに不慣れな方向けに、直感的に操作できるWindows標準のGUIツール (`acvs_gui.ps1`) を同梱しています。

## インストール (Installation)

現状はPythonの単一スクリプトとして動作します。標準ライブラリのみを使用しているため、追加の `pip install` は不要です。

```bash
git clone https://github.com/o3x/ACF-VS.git
cd ACF-VS
```

## 使い方 (Usage)

各コマンドは対象となるカットディレクトリのルートで実行するのを基本とします。

### 1. マニフェストの初期化 (`init`)
現在のフォルダの状態をスキャンし、`.cut_manifest.json` を生成します。
```bash
python acvs_core.py init --dir <対象のカットフォルダパス>
```

### 2. 現在の差分を確認 (`status` / `scan`)
前回のマニフェストと比較し、新規追加・更新・削除・アーカイブ移動などの差分を表示します（マニフェストは更新されません）。
```bash
# 通常スキャン
python acvs_core.py status --dir <対象のカットフォルダパス>

# アニメ特化のオプション：巨大ファイル向け高速化 ＆ 連番画像のグループ化
python acvs_core.py status --dir <対象のカットフォルダパス> --fast --seq
```

### 3. マニフェストの更新と履歴保存 (`commit`)
現状のスキャン結果を新しい「正」としてマニフェストを上書き保存し、同時に `.acvs_history` フォルダに過去スナップショットを記録します。
```bash
python acvs_core.py commit --dir <対象のカットフォルダパス> --fast --seq
```

### 4. 履歴の確認 (`log` / `diff`)
過去のコミット履歴を確認し、特定の時点からの差分（変更されたファイル）を調査できます。
```bash
# 過去のコミット履歴（日時）とステータスを一覧表示
python acvs_core.py log --dir <対象のカットフォルダパス>

# 指定した日時の履歴と現在の状態を比較（logで得たタイムスタンプを指定）
python acvs_core.py diff --target 20260227_182939 --dir <対象のカットフォルダパス> --fast --seq
```

## GUI の使い方 (For Windows)
付属の PowerShell スクリプトを実行すると、コマンドを打たなくても画面上から ACF-VS を操作できます。

1. エクスプローラー上で `acvs_gui.ps1` を右クリックし、「PowerShell で実行」を選択してください。（またはVS Codeのターミナル等から `.\acvs_gui.ps1` を実行）
2. 「エピソードルート (Root Dir)」を指定（例: `C:\Anime\Ep01`）します。
3. 調べたい「カット番号 (例: c001)」を入力してエンターキーを押すか、`Scan (Status)` などのボタンを押すと、下部の黒いコンソールに結果が表示されます。

## 開発環境向け

テスト用にダミーの連番画像環境を一括生成するスクリプトが付属しています。
```bash
python test_seq_generator.py --dir test_env --count 1000
```
これにより、`test_env` フォルダ内にCELLやBGのダミー連番が生成され、ACF-VS の挙動テストに利用できます。

## ライセンス (License)
MIT License
